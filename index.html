<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Mastery - Learn & Grow</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- AOS for Animations -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- All CSS has been embedded here -->
    <style>
        :root {
            --heading-font: 'Outfit', sans-serif;
            --body-font: 'Plus Jakarta Sans', sans-serif;
            --primary-color: #ff6b6b;
            --secondary-color: #ff5252;
            --dark-color: #2d3436;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --text-color: #636e72;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
        }

        /* Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            background-color: var(--light-gray);
            color: var(--dark-color);
            line-height: 1.6;
            font-family: var(--body-font);
        }
        h1, h2, h3, h4 { font-family: var(--heading-font); font-weight: 700; line-height: 1.2; }
        
        /* Navbar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .navbar.scrolled { padding: 1rem 5%; background: rgba(255, 255, 255, 0.98); }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); text-decoration: none; }
        .nav-links a { margin: 0 1.5rem; text-decoration: none; color: var(--dark-color); font-weight: 500; transition: color 0.3s ease; }
        .nav-links a:hover { color: var(--primary-color); }
        .nav-buttons { display: flex; align-items: center; gap: 1rem; }
        .login-btn, .admin-btn { padding: 0.8rem 1.5rem; color: white; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .login-btn { background: var(--primary-color); } .login-btn:hover { background: var(--secondary-color); transform: translateY(-2px); }
        .admin-btn { display: none; background: #6c757d; width: 45px; height: 45px; border-radius: 50%; padding: 0.8rem;}

        /* Hero Section */
        .hero { min-height: 100vh; display: flex; align-items: center; padding: 8rem 5% 5rem; background: linear-gradient(135deg, var(--light-gray) 0%, var(--medium-gray) 100%); }
        .hero-content { flex: 1; }
        .hero-content h1 { font-size: 3.5rem; margin-bottom: 1.5rem; }
        .hero-content p { font-size: 1.2rem; color: var(--text-color); margin-bottom: 2rem; }
        .cta-button { padding: 1rem 2rem; font-size: 1.1rem; background: var(--primary-color); color: white; border: none; border-radius: 30px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .cta-button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4); }
        .hero-image { flex: 1; display: flex; justify-content: center; align-items: center; }
        .hero-image img { max-width: 100%; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }

        /* Courses Section */
        .courses { padding: 5rem 5%; background: white; }
        .courses h2 { text-align: center; font-size: 2.5rem; margin-bottom: 1rem; }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .course-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07); transition: transform 0.3s ease; position: relative; }
        .course-card:hover { transform: translateY(-10px); }
        .course-video-container { position: relative; width: 100%; height: 200px; background: #000; display: flex; align-items: center; justify-content: center; }
        .course-video { width: 100%; height: 100%; border: none; }
        .course-video-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .course-video-placeholder i { font-size: 3rem; opacity: 0.8; }
        .course-content { padding: 1.5rem; }
        .course-content h3 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .course-content p { color: var(--text-color); margin-bottom: 1rem; min-height: 48px; }
        .price { display: block; font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; }
        .buy-btn { width: 100%; padding: 0.8rem; font-size: 1rem; }
        .new-course-badge { position: absolute; top: 10px; right: 10px; background: var(--primary-color); color: white; font-size: 0.8rem; font-weight: 700; padding: 0.3rem 0.6rem; border-radius: 15px; z-index: 10; }

        /* General Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); z-index: 1001; display: none; opacity: 0; transition: opacity 0.3s ease; align-items: center; justify-content: center; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { position: relative; background: white; width: 90%; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); transform: translateY(-20px); transition: transform 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal.active .modal-content { transform: translateY(0); }
        .modal-header { padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--medium-gray); }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .close-modal-btn { font-size: 2rem; cursor: pointer; color: #6c757d; border: none; background: transparent; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--medium-gray); display: flex; justify-content: flex-end; gap: 1rem; }

        /* Auth Modal */
        .auth-modal .modal-content { max-width: 400px; }
        .auth-tabs { display: flex; margin-bottom: 2rem; border-bottom: 2px solid #f1f1f1; }
        .tab-btn { flex: 1; padding: 1rem; background: none; border: none; font-size: 1.1rem; cursor: pointer; }
        .tab-btn.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
        .google-auth-btn { width: 100%; padding: 1rem; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }

        /* User Menu */
        .user-menu { position: fixed; top: 80px; right: 5%; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); z-index: 1001; min-width: 250px; animation: slideDown 0.3s ease; }
        .user-menu-content { padding: 1rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--medium-gray); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .user-menu-links a { display: block; padding: 0.75rem 1rem; text-decoration: none; color: var(--dark-color); border-radius: 6px; transition: all 0.2s; }
        .user-menu-links a:hover { background: var(--light-gray); color: var(--primary-color); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Admin Panel */
        .admin-modal .modal-content { max-width: 1200px; width: 95%; }
        .admin-tabs { display: flex; background: var(--light-gray); border-bottom: 1px solid var(--medium-gray); padding: 0 1rem; }
        .admin-tab-btn { padding: 1rem; font-size: 1rem; background: none; border: none; cursor: pointer; border-bottom: 3px solid transparent; }
        .admin-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .admin-tab-content { display: none; } .admin-tab-content.active { display: block; }
        .admin-actions { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .admin-action-btn { padding: 0.75rem 1.5rem; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .admin-action-btn.secondary { background: #6c757d; }
        .table-container { overflow-x: auto; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 1rem; border-bottom: 1px solid var(--medium-gray); text-align: left; }
        .admin-table th { background: var(--light-gray); }
        .action-btn { background: none; border: none; cursor: pointer; border-radius: 6px; padding: 0.5rem; margin: 0 0.2rem; }
        .edit-btn { color: #007bff; } .delete-btn { color: var(--danger-color); } .admin-status-btn { color: #ffc107; }
        
        /* Request Details Modal */
        .request-details-modal .modal-content { max-width: 600px; }
        .screenshot-img { max-width: 100%; border-radius: 8px; margin-top: 1rem; }

        /* Purchase Modal & My Courses Modal */
        .purchase-modal .modal-content { max-width: 800px; }
        .my-courses-modal .modal-content { max-width: 1000px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--medium-gray); border-radius: 6px; }
        .qr-code { width: 150px; height: 150px; }
        .upload-area { border: 2px dashed #dee2e6; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; }
        .screenshot-preview img { width: 100%; max-height: 200px; object-fit: contain; }
        .my-courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .my-course-card { border: 1px solid var(--medium-gray); border-radius: 12px; overflow: hidden; }
        .my-course-image { position: relative; height: 180px; } .my-course-image img { width: 100%; height: 100%; object-fit: cover; }
        .status-badge { position: absolute; top: 1rem; right: 1rem; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; color: white; }
        .status-pending { background: #ffc107; } .status-approved { background: var(--success-color); } .status-rejected { background: var(--danger-color); }

        /* Helper & Misc Classes */
        .success-message, .error-message { position: fixed; top: 20px; right: 20px; color: white; padding: 1rem; border-radius: 8px; z-index: 10002; display: none; animation: slideInRight 0.5s ease; }
        .success-message { background: var(--success-color); }
        .error-message { background: var(--danger-color); }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .mobile-menu-btn { display: none; }
        .mobile-menu { display: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .hero { flex-direction: column; text-align: center; }
            .nav-links, .nav-buttons .login-btn, .nav-buttons .admin-btn { display: none; }
            .mobile-menu-btn { display: block; background: none; border: none; font-size: 1.5rem; z-index: 1002;}
            .mobile-menu { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1001; padding: 2rem; transform: translateX(-100%); transition: transform 0.3s ease; }
            .mobile-menu.active { transform: translateX(0); }
            .mobile-menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
            .mobile-menu-close { background: none; border: none; font-size: 1.5rem; }
            .mobile-nav-links { display: flex; flex-direction: column; gap: 1.5rem; }
            .mobile-nav-links a, .mobile-nav-links button { font-size: 1.2rem; text-decoration: none; color: var(--dark-color); }
            .mobile-nav-links button { text-align: left; padding: 0; background: none; border: none; cursor: pointer; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="#home" class="logo">Trade Mastery</a>
        <div class="nav-links">
            <a href="#home">Home</a>
            <a href="#courses">Courses</a>
        </div>
        <div class="nav-buttons">
            <button class="admin-btn" onclick="openAdminPanel()" title="Admin Panel"><i class="fas fa-cog"></i></button>
            <button class="login-btn" onclick="openModal('authModal')">Login</button>
        </div>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
    </nav>
    
    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <div class="logo">Trade Mastery</div>
            <button class="mobile-menu-close" onclick="toggleMobileMenu()"><i class="fas fa-times"></i></button>
        </div>
        <div class="mobile-nav-links">
            <a href="#home" onclick="toggleMobileMenu()">Home</a>
            <a href="#courses" onclick="toggleMobileMenu()">Courses</a>
            <button class="login-btn-mobile" onclick="openModal('authModal'); toggleMobileMenu();">Login</button>
            <button class="admin-btn-mobile" style="display:none;" onclick="openAdminPanel(); toggleMobileMenu();">Admin Panel</button>
        </div>
    </div>

    <!-- Main Content -->
    <main>
        <section id="home" class="hero">
            <div class="hero-content" data-aos="fade-up">
                <h1>Unlock Your Potential</h1>
                <p>Join Trade Mastery to gain skills, get certified, and advance your career with our expert-led courses.</p>
                <button class="cta-button" onclick="document.getElementById('courses').scrollIntoView()">Explore Courses</button>
            </div>
            <div class="hero-image" data-aos="fade-left">
                <img src="https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&q=80&w=1350" alt="Students learning">
            </div>
        </section>

        <section id="courses" class="courses">
            <h2 data-aos="fade-up">Our Courses</h2>
            <div class="course-grid">
                <!-- Courses will be loaded here by JavaScript -->
            </div>
        </section>
    </main>
    
    <!-- Footer -->
    <footer>
        <div class="footer-bottom" style="text-align:center; padding: 2rem; background: var(--dark-color); color: white;">
            <p>&copy; 2024 Trade Mastery. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modals -->

    <!-- Auth Modal -->
    <div class="modal auth-modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome</h2>
                <button class="close-modal-btn" onclick="closeModal('authModal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;">
                <p>Sign in or create an account to continue.</p>
                <button class="google-auth-btn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> Continue with Google</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal admin-modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Admin Panel</h2>
                <button class="close-modal-btn" onclick="closeModal('adminModal')">&times;</button>
            </div>
            <div class="admin-tabs">
                <button class="admin-tab-btn active" onclick="switchAdminTab(event, 'courses')">Courses</button>
                <button class="admin-tab-btn" onclick="switchAdminTab(event, 'requests')">Requests</button>
                <button class="admin-tab-btn" onclick="switchAdminTab(event, 'users')">Users</button>
            </div>
            <div class="modal-body">
                <!-- Courses Tab -->
                <div id="coursesTab" class="admin-tab-content active">
                    <div class="admin-actions">
                        <button class="admin-action-btn" onclick="showCourseForm()">Add New Course</button>
                    </div>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead><tr><th>Course</th><th>Price</th><th>Actions</th></tr></thead>
                            <tbody id="coursesTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Requests Tab -->
                <div id="requestsTab" class="admin-tab-content">
                    <div class="table-container">
                        <table class="admin-table">
                            <thead><tr><th>User</th><th>Course</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="requestsTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Users Tab -->
                <div id="usersTab" class="admin-tab-content">
                    <div class="table-container">
                        <table class="admin-table">
                            <thead><tr><th>User</th><th>Email</th><th>Admin</th><th>Actions</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Course Form Modal -->
    <div class="modal course-form-modal" id="courseFormModal">
        <div class="modal-content" style="max-width: 600px;">
             <form id="courseForm" onsubmit="saveCourse(event)">
                <div class="modal-header">
                    <h2 id="courseFormTitle">Add Course</h2>
                    <button type="button" class="close-modal-btn" onclick="closeModal('courseFormModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="courseId">
                    <div class="form-group">
                        <label for="courseTitle">Course Title</label>
                        <input type="text" id="courseTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="courseDescription">Description</label>
                        <textarea id="courseDescription" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="coursePrice">Price ($)</label>
                        <input type="number" id="coursePrice" required>
                    </div>
                    <div class="form-group">
                        <label for="courseVideoLink">YouTube Video URL</label>
                        <input type="url" id="courseVideoLink" placeholder="https://www.youtube.com/watch?v=..." required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-action-btn secondary" onclick="closeModal('courseFormModal')">Cancel</button>
                    <button type="submit" class="admin-action-btn">Save Course</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Purchase Modal -->
    <div class="modal purchase-modal" id="purchaseModal">
        <div class="modal-content">
            <form id="purchaseForm" onsubmit="submitPurchase(event)">
                <div class="modal-header"><h2>Purchase Course</h2><button type="button" class="close-modal-btn" onclick="closeModal('purchaseModal')">&times;</button></div>
                <div class="modal-body">
                    <h3 id="purchaseCourseTitle"></h3>
                    <p>To complete your purchase, please make the payment using the QR code below and upload a screenshot of the transaction.</p>
                    <div style="text-align: center; margin: 1rem 0;">
                        <img src="https://i.ibb.co/6r2R8Tq/qr.png" alt="Payment QR Code" class="qr-code">
                        <p id="purchaseCoursePrice" style="font-weight: bold; margin-top: 0.5rem;"></p>
                    </div>
                    <div class="form-group">
                        <label for="paymentScreenshot">Payment Screenshot</label>
                        <div class="upload-area" onclick="document.getElementById('paymentScreenshotInput').click();">
                            <p>Click to upload</p>
                        </div>
                        <input type="file" id="paymentScreenshotInput" accept="image/*" required style="display:none;" onchange="previewScreenshot(event)">
                         <div class="screenshot-preview" id="screenshotPreview" style="display: none; margin-top: 1rem; text-align: center;">
                            <img id="previewImage" src="" alt="Screenshot Preview">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="admin-action-btn secondary" onclick="closeModal('purchaseModal')">Cancel</button>
                    <button type="submit" class="admin-action-btn">Submit for Review</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div class="modal request-details-modal" id="requestDetailsModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Request Details</h2><button class="close-modal-btn" onclick="closeModal('requestDetailsModal')">&times;</button></div>
            <div class="modal-body" id="requestDetailsBody">
                <!-- Details will be injected by JS -->
            </div>
            <div class="modal-footer" id="requestDetailsFooter">
                 <!-- Actions will be injected by JS -->
            </div>
        </div>
    </div>
    
     <!-- My Courses Modal -->
    <div class="modal my-courses-modal" id="myCoursesModal">
        <div class="modal-content">
            <div class="modal-header"><h2>My Courses</h2><button class="close-modal-btn" onclick="closeModal('myCoursesModal')">&times;</button></div>
            <div class="modal-body">
                <div class="my-courses-grid" id="myCoursesContent">
                    <!-- User's courses will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Banners -->
    <div class="success-message" id="notificationBanner"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <!-- AOS Library -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Main Application JavaScript -->
    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your actual Firebase API key
            authDomain: "YOUR_AUTH_DOMAIN", // e.g., your-project-id.firebaseapp.com
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET", // e.g., your-project-id.appspot.com
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const PERMANENT_ADMIN_EMAIL = "your-admin-email@example.com"; // Replace with your admin email

        // --- GLOBAL STATE & CACHE ---
        let currentUser = null;
        let isAdmin = false;
        let allCoursesCache = [];
        let currentPurchaseCourse = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                firebase.initializeApp(firebaseConfig);
                window.auth = firebase.auth();
                window.db = firebase.firestore();
                window.googleProvider = new firebase.auth.GoogleAuthProvider();
                console.log("Firebase initialized.");
                initializeAuthListener();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = "<h1>Error: Could not connect to the database. Please check Firebase configuration.</h1>";
            }
            AOS.init({ duration: 800, once: true });
            loadFeaturedCourses();
        });

        // --- AUTHENTICATION ---
        function initializeAuthListener() {
            auth.onAuthStateChanged(async user => {
                currentUser = user;
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    isAdmin = user.email === PERMANENT_ADMIN_EMAIL || (userDoc.exists && userDoc.data().isAdmin === true);
                } else {
                    isAdmin = false;
                }
                updateUIAfterAuthStateChange();
            });
        }

        function updateUIAfterAuthStateChange() {
            const loginBtn = document.querySelector('.nav-buttons .login-btn');
            const adminBtn = document.querySelector('.nav-buttons .admin-btn');
            const mobileLoginBtn = document.querySelector('.mobile-nav-links .login-btn-mobile');
            const mobileAdminBtn = document.querySelector('.mobile-nav-links .admin-btn-mobile');
            
            if (currentUser) {
                loginBtn.textContent = 'My Account';
                loginBtn.onclick = showUserMenu;
                mobileLoginBtn.textContent = 'My Account';
                mobileLoginBtn.onclick = () => { showUserMenu(); toggleMobileMenu(); };
            } else {
                loginBtn.textContent = 'Login';
                loginBtn.onclick = () => openModal('authModal');
                mobileLoginBtn.textContent = 'Login';
                mobileLoginBtn.onclick = () => { openModal('authModal'); toggleMobileMenu(); };
            }

            adminBtn.style.display = isAdmin ? 'block' : 'none';
            mobileAdminBtn.style.display = isAdmin ? 'block' : 'none';
        }

        async function signInWithGoogle() {
            try {
                const result = await auth.signInWithPopup(googleProvider);
                await storeUserData(result.user);
                closeModal('authModal');
                showNotification("Signed in successfully!");
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showNotification("Error signing in. Please try again.", true);
            }
        }

        async function storeUserData(user) {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();
            const userData = {
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
            };
            if (!userDoc.exists) {
                userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                userData.isAdmin = user.email === PERMANENT_ADMIN_EMAIL;
            }
            await userRef.set(userData, { merge: true });
        }
        
        function signOutUser() {
            auth.signOut().then(() => {
                showNotification("You have been signed out.");
                const menu = document.querySelector('.user-menu');
                if (menu) menu.remove();
            });
        }

        // --- UI & MODALS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function toggleMobileMenu() { document.getElementById('mobileMenu').classList.toggle('active'); }
        
        function showUserMenu() {
            if(document.querySelector('.user-menu')) {
                 document.querySelector('.user-menu').remove();
                 return;
            }
            const menu = document.createElement('div');
            menu.className = 'user-menu';
            menu.innerHTML = `
                <div class="user-menu-content">
                    <div class="user-info">
                        <img src="${currentUser.photoURL || 'https://via.placeholder.com/40'}" class="user-avatar">
                        <div><h4>${currentUser.displayName}</h4></div>
                    </div>
                    <div class="user-menu-links">
                        <a href="#" onclick="showMyCourses()">My Courses</a>
                        ${isAdmin ? '<a href="#" onclick="openAdminPanel()">Admin Panel</a>' : ''}
                        <a href="#" onclick="signOutUser()">Sign Out</a>
                    </div>
                </div>`;
            document.body.appendChild(menu);
            setTimeout(() => document.addEventListener('click', e => { if (!menu.contains(e.target) && !e.target.closest('.login-btn')) menu.remove(); }, { once: true }), 0);
        }
        
        function showNotification(message, isError = false) {
            const banner = document.getElementById('notificationBanner');
            banner.textContent = message;
            banner.className = isError ? 'error-message' : 'success-message';
            banner.style.display = 'block';
            setTimeout(() => { banner.style.display = 'none'; }, 4000);
        }

        // --- COURSE DISPLAY & SEARCH ---
        async function loadFeaturedCourses() {
            const grid = document.querySelector('.course-grid');
            try {
                const snapshot = await db.collection('courses').orderBy('createdAt', 'desc').get();
                allCoursesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayCoursesOnGrid(allCoursesCache);
            } catch(e) {
                console.error("Error loading courses: ", e);
                grid.innerHTML = "<p>Could not load courses. Please try again later.</p>";
            }
        }
        
        function displayCoursesOnGrid(courses) {
            const grid = document.querySelector('.course-grid');
            grid.innerHTML = courses.length ? courses.map(course => {
                const isNew = course.createdAt && (Date.now() - new Date(course.createdAt.seconds * 1000)) < 7 * 24 * 60 * 60 * 1000;
                return `
                <div class="course-card" data-aos="fade-up">
                    ${isNew ? '<div class="new-course-badge">NEW</div>' : ''}
                    <div class="course-video-container">
                        <iframe class="course-video" src="${getVideoEmbedUrl(course.videoLink)}" title="${course.title}" frameborder="0" allowfullscreen></iframe>
                    </div>
                    <div class="course-content">
                        <h3>${course.title}</h3>
                        <p>${course.description}</p>
                        <span class="price">$${course.price}</span>
                        <button class="login-btn buy-btn" onclick="showPurchaseForm('${course.id}')">Buy Now</button>
                    </div>
                </div>`;
            }).join('') : "<p>No courses available at the moment.</p>";
        }
        
        function getVideoEmbedUrl(url) {
            if (!url) return '';
            let videoId = null;
            const patterns = [ /v=([a-zA-Z0-9_-]{11})/, /youtu\.be\/([a-zA-Z0-9_-]{11})/ ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) { videoId = match[1]; break; }
            }
            return videoId ? `https://www.youtube.com/embed/${videoId}?rel=0` : '';
        }

        // --- PURCHASE FLOW ---
        function showPurchaseForm(courseId) {
            if (!currentUser) { showNotification("Please sign in to purchase a course.", true); openModal('authModal'); return; }
            currentPurchaseCourse = allCoursesCache.find(c => c.id === courseId);
            if (!currentPurchaseCourse) return;
            document.getElementById('purchaseCourseTitle').textContent = currentPurchaseCourse.title;
            document.getElementById('purchaseCoursePrice').textContent = `Price: $${currentPurchaseCourse.price}`;
            openModal('purchaseModal');
        }

        function previewScreenshot(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('previewImage').src = URL.createObjectURL(file);
                document.getElementById('screenshotPreview').style.display = 'block';
            }
        }
        
        async function submitPurchase(event) {
            event.preventDefault();
            const screenshotFile = document.getElementById('paymentScreenshotInput').files[0];
            if (!screenshotFile) { showNotification("Please upload a payment screenshot.", true); return; }
            
            showNotification("Submitting your request...");
            try {
                const screenshotData = await fileToBase64(screenshotFile);
                const requestData = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userEmail: currentUser.email,
                    courseId: currentPurchaseCourse.id,
                    courseTitle: currentPurchaseCourse.title,
                    screenshotData: screenshotData,
                    status: 'Pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                };
                // Create purchase request
                await db.collection('requests').add(requestData);
                // Create entry in user's courses
                await db.collection('userCourses').add({
                    userId: currentUser.uid,
                    courseId: currentPurchaseCourse.id,
                    courseTitle: currentPurchaseCourse.title,
                    purchaseDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'Pending'
                });
                closeModal('purchaseModal');
                showNotification("Purchase request submitted successfully!");
            } catch (e) {
                console.error("Purchase Error: ", e);
                showNotification("Failed to submit request. Please try again.", true);
            }
        }

        // --- MY COURSES ---
        async function showMyCourses() {
             if (!currentUser) { openModal('authModal'); return; }
            openModal('myCoursesModal');
            const content = document.getElementById('myCoursesContent');
            content.innerHTML = '<p>Loading your courses...</p>';
            const snapshot = await db.collection('userCourses').where('userId', '==', currentUser.uid).orderBy('purchaseDate', 'desc').get();
            const courses = snapshot.docs.map(doc => doc.data());
            
            if (courses.length === 0) {
                content.innerHTML = '<p>You have not purchased any courses yet.</p>';
                return;
            }
            content.innerHTML = courses.map(c => {
                 const courseDetails = allCoursesCache.find(ac => ac.id === c.courseId);
                 const videoUrl = courseDetails ? getVideoEmbedUrl(courseDetails.videoLink) : '';
                return `
                <div class="my-course-card">
                    <div class="my-course-image">
                        <div class="status-badge status-${c.status.toLowerCase()}">${c.status}</div>
                    </div>
                    <div style="padding: 1rem;">
                        <h3>${c.courseTitle}</h3>
                        <p>Purchased: ${new Date(c.purchaseDate.seconds * 1000).toLocaleDateString()}</p>
                        ${c.status === 'Approved' ? `<a href="${videoUrl}" target="_blank" class="login-btn buy-btn" style="text-decoration:none; display:inline-block; text-align:center;">Access Course</a>` : ''}
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- ADMIN PANEL ---
        function openAdminPanel() {
            if (!isAdmin) { showNotification("Access Denied.", true); return; }
            openModal('adminModal');
            loadAdminCourses(); // Load courses by default
        }
        
        function switchAdminTab(event, tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'courses') loadAdminCourses();
            if (tabName === 'requests') loadAdminRequests();
            if (tabName === 'users') loadAdminUsers();
        }

        // Admin: Courses
        async function loadAdminCourses() {
            const snapshot = await db.collection('courses').orderBy('createdAt', 'desc').get();
            const courses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            document.getElementById('coursesTableBody').innerHTML = courses.map(c => `
                <tr>
                    <td>${c.title}</td><td>$${c.price}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="showCourseForm('${c.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteCourse('${c.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        function showCourseForm(courseId = null) {
            const form = document.getElementById('courseForm');
            form.reset();
            document.getElementById('courseId').value = '';
            if (courseId) {
                const course = allCoursesCache.find(c => c.id === courseId);
                if (course) {
                    document.getElementById('courseFormTitle').textContent = 'Edit Course';
                    document.getElementById('courseId').value = course.id;
                    document.getElementById('courseTitle').value = course.title;
                    document.getElementById('courseDescription').value = course.description;
                    document.getElementById('coursePrice').value = course.price;
                    document.getElementById('courseVideoLink').value = course.videoLink;
                }
            } else {
                 document.getElementById('courseFormTitle').textContent = 'Add Course';
            }
            openModal('courseFormModal');
        }

        async function saveCourse(event) {
            event.preventDefault();
            const courseId = document.getElementById('courseId').value;
            const courseData = {
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                price: parseFloat(document.getElementById('coursePrice').value),
                videoLink: document.getElementById('courseVideoLink').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                if (courseId) {
                    await db.collection('courses').doc(courseId).update(courseData);
                    showNotification("Course updated!");
                } else {
                    courseData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('courses').add(courseData);
                    showNotification("Course added!");
                }
                closeModal('courseFormModal');
                loadAdminCourses();
                loadFeaturedCourses(); // Refresh main page
            } catch(e) {
                console.error("Error saving course:", e);
                showNotification("Error saving course.", true);
            }
        }
        
        async function deleteCourse(id) {
            if (!confirm("Are you sure you want to delete this course?")) return;
            await db.collection('courses').doc(id).delete();
            loadAdminCourses();
            loadFeaturedCourses();
            showNotification("Course deleted.");
        }

        // Admin: Requests
        async function loadAdminRequests() {
            const snapshot = await db.collection('requests').orderBy('createdAt', 'desc').get();
            const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            document.getElementById('requestsTableBody').innerHTML = requests.map(r => `
                <tr>
                    <td>${r.userName}</td><td>${r.courseTitle}</td>
                    <td>${new Date(r.createdAt.seconds * 1000).toLocaleDateString()}</td>
                    <td><span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span></td>
                    <td><button class="action-btn" onclick="viewRequestDetails('${r.id}')"><i class="fas fa-eye"></i></button></td>
                </tr>`).join('');
        }
        
        async function viewRequestDetails(requestId) {
            const doc = await db.collection('requests').doc(requestId).get();
            if (!doc.exists) { showNotification("Request not found.", true); return; }
            const req = { id: doc.id, ...doc.data() };
            
            document.getElementById('requestDetailsBody').innerHTML = `
                <p><strong>User:</strong> ${req.userName} (${req.userEmail})</p>
                <p><strong>Course:</strong> ${req.courseTitle}</p>
                <p><strong>Status:</strong> ${req.status}</p>
                <p><strong>Screenshot:</strong></p>
                <img src="${req.screenshotData}" alt="Payment Screenshot" class="screenshot-img">
            `;
            document.getElementById('requestDetailsFooter').innerHTML = req.status === 'Pending' ? `
                <button class="admin-action-btn secondary" onclick="updateRequestStatus('${req.id}', 'Rejected')">Reject</button>
                <button class="admin-action-btn" style="background:var(--success-color)" onclick="updateRequestStatus('${req.id}', 'Approved')">Approve</button>
            ` : '';
            openModal('requestDetailsModal');
        }

        async function updateRequestStatus(requestId, status) {
            try {
                // Update the request itself
                await db.collection('requests').doc(requestId).update({ status: status });
                
                // Find the corresponding userCourse entry and update it
                const reqDoc = await db.collection('requests').doc(requestId).get();
                const reqData = reqDoc.data();
                const userCourseQuery = await db.collection('userCourses').where('userId', '==', reqData.userId).where('courseId', '==', reqData.courseId).where('status', '==', 'Pending').limit(1).get();
                
                if (!userCourseQuery.empty) {
                    const userCourseDocId = userCourseQuery.docs[0].id;
                    await db.collection('userCourses').doc(userCourseDocId).update({ status: status });
                }
                
                showNotification(`Request has been ${status.toLowerCase()}.`);
                closeModal('requestDetailsModal');
                loadAdminRequests();
            } catch (e) {
                console.error("Error updating status: ", e);
                showNotification("Failed to update status.", true);
            }
        }
        
        // Admin: Users
        async function loadAdminUsers() {
             const snapshot = await db.collection('users').get();
             const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             document.getElementById('usersTableBody').innerHTML = users.map(u => `
                <tr>
                    <td>${u.displayName}</td><td>${u.email}</td><td>${u.isAdmin ? 'Yes' : 'No'}</td>
                    <td><button class="action-btn admin-status-btn" onclick="toggleAdminStatus('${u.id}', ${!u.isAdmin})"><i class="fas fa-crown"></i></button></td>
                </tr>`).join('');
        }
        
        async function toggleAdminStatus(userId, makeAdmin) {
            if (userId === currentUser.uid && !makeAdmin) {
                if (!confirm("Are you sure you want to remove your own admin status?")) return;
            }
            await db.collection('users').doc(userId).update({ isAdmin: makeAdmin });
            showNotification("Admin status updated.");
            loadAdminUsers();
        }

        // --- UTILITIES ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
